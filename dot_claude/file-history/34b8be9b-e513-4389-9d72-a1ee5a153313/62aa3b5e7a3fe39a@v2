import { useState, useEffect, useRef, useCallback } from 'react';
import { useTimerContext } from '../context/TimerContext';
import { ALL_COMBINATIONS } from '../utils/constants';

export function useCombinations() {
  const { state, settings } = useTimerContext();
  const [currentCombo, setCurrentCombo] = useState<string | null>(null);
  const [isVisible, setIsVisible] = useState(false);
  const lastComboTimeRef = useRef(0);
  const timeoutRef = useRef<number | null>(null);

  const showCombo = useCallback(() => {
    const randomIndex = Math.floor(Math.random() * ALL_COMBINATIONS.length);
    setCurrentCombo(ALL_COMBINATIONS[randomIndex]);
    setIsVisible(true);

    // Hide after 2 seconds
    if (timeoutRef.current) {
      clearTimeout(timeoutRef.current);
    }
    timeoutRef.current = window.setTimeout(() => {
      setIsVisible(false);
    }, 2000);
  }, []);

  useEffect(() => {
    // Only show combos during active rounds
    if (
      state.status !== 'running' ||
      state.phase !== 'round' ||
      !settings.combosEnabled
    ) {
      setIsVisible(false);
      return;
    }

    // Calculate elapsed time in current round
    const elapsedTime = state.roundDuration - state.timeRemaining;

    // Check if it's time to show a new combo
    if (
      elapsedTime > 0 &&
      elapsedTime >= lastComboTimeRef.current + settings.comboInterval
    ) {
      lastComboTimeRef.current = elapsedTime;
      showCombo();
    }

    // Reset on new round
    if (state.timeRemaining === state.roundDuration) {
      lastComboTimeRef.current = 0;
    }
  }, [state, settings.combosEnabled, settings.comboInterval, showCombo]);

  // Reset when round changes or timer resets
  useEffect(() => {
    if (state.status === 'idle') {
      lastComboTimeRef.current = 0;
      setIsVisible(false);
      setCurrentCombo(null);
    }
  }, [state.status, state.currentRound]);

  // Cleanup
  useEffect(() => {
    return () => {
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }
    };
  }, []);

  return { currentCombo, isVisible };
}
